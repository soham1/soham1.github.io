<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8">
  <title></title>
  <link rel="stylesheet" href="bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
  <script src="js/raphael-min.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/jquery-ui/jquery-ui.min.js"></script>
  <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  
  <style>
    #canvas {
      height: 600px;
      margin: 0 auto;
      text-align: left;
      width: 600px;
    }    
    
    #canvas, #logArea{
      float: left;
    }
    
    #logArea tr td{
      text-align: center;
    }
    
    #sliderN, #speed{
      width: 200px;
      margin: 10px;
    }
    
    #sliderMsg, #speedMsg{
      margin-left: 10px;
    }
  </style>
  
  <script>

    
var paper;
var radius = 250;
var points = new Array();
var seat = new Array();
var currentPos = 0;
var totalIterations = 1;    
var speed = 200;    
var live = true;    
var timerId;    
var startFrom = 3;
var doTill = 16;    
var config = {x: 300, y:300, r:150, n:startFrom, s:0 };    
var stopAll = true;    
    
$(function(){
  init();
});

function init(){
  paper = Raphael("canvas", 600, 600);

  $('#startBtn').click(function(){
    config.n = startFrom;
    start();
  });
  
  $('#stopBtn').click(function(){
    stop();
  });
  
  $( "#sliderN" ).slider({
    range: true,
    min: 1,
    max: 40,
    values: [ 3, 16 ],
    slide: function( event, ui ) {
      startFrom = ui.values[ 0 ];
      doTill = ui.values[ 1 ];
      $( "#sliderMsg" ).text( 'Simulate ' + ui.values[ 0 ] + " to " + ui.values[ 1 ] + ' seats');
    }
  });
  
  $( "#speed" ).slider({
    min: 200,
    max: 5000,
    value: 5000,
    step: 100,
    slide: function( event, ui ) {
      speed = 5200 - ui.value;
      //console.log('speed', speed);
      $( "#speedMsg" ).text( 'Speed is ' + ui.value);
    }
  });
  
}

function isOneLiveLeft(){
  var liveCount = 0;
  for(var i = 0; i < seat.length; i++){
    if(seat[i].live){
      liveCount++
    }
    if(liveCount > 1){
      return false;
    }
  }
  return true;
}

function findLive(){
  for(var i = 0; i < seat.length; i++){
    if(seat[i].live){
      return i + 1;
    }
  }
  return 0;
}

function stop(){
  stopAll = true;
  if(timerId){
    //clearInterval(timerId);
    clearTimeout(timerId);
  }
}
    
function start(){
  stopAll = false;
  paper.clear();
  points = new Array();
  seat = new Array();
  currentPos = 0;
  speed = 5200 - $( "#speed" ).slider('value');
  //console.log(speed);
  shape(config);
  //timerId = setInterval(moveToNext, speed);
  timerId = setTimeout(moveToNext, speed);
  //moveToNext();
}
    
function moveToNext(){
  if(stopAll){
    console.log('stopping');
    return;
  }
  //console.log(currentPos, totalIterations);
  var pointTxt = new Object;
  //var rad = config.r + (totalIterations* 20);
  var rad = config.r + 30;
  var angle = config.s + (currentPos * (1 / config.n) * 2 * Math.PI);
  pointTxt.x = Math.round(config.x + rad * Math.cos(angle));
  pointTxt.y = Math.round(config.y + rad * Math.sin(angle));
  //var t = paper.text(pointTxt.x, pointTxt.y, (currentPos + 1) + ',' + totalIterations ).attr({'text-anchor': 'middle'});  
  
  if(seat[currentPos].live){
    seat[currentPos].live = live;
    var circle = paper.circle(pointTxt.x, pointTxt.y, 10);
    circle.attr("stroke", "#fff");    
    if(live){
      circle.attr("fill", "#00FF00");
    }else{
      circle.attr("fill", "#f00");
    }
    live = !live;
  }
  
  if(!seat[currentPos].live){
    $('#log').prepend('<li>#' + (currentPos + 1) + ' is dead!</li>');
  }
  
  if(isOneLiveLeft()){
    //clearInterval(timerId);
    clearTimeout(timerId);
    console.log('DONE');
    var surviver = findLive();
    log("#" + surviver + ' is the SURVIVER');
    $('#resultTable').append('<tr><td>' + config.n + '</td><td>' + surviver + '</td></tr>');
    
    if(config.n < doTill){
      config.n = config.n + 1;
      start();
      /*
      paper.clear();
      points = new Array();
      seat = new Array();
      currentPos = 0;
      shape(config);
      timerId = setInterval(moveToNext, speed);
      */
    }
    return;
  }
  
  for(var i = 0; i < config.n; i++){
    incrementCurrentPos();
    if(seat[currentPos].live){
      break;
    }
  }
  
  timerId = setTimeout(moveToNext, speed);
}
    
function log(msg){
  $('#log').prepend('<li>' + msg+ '</li>');
}    
    
function incrementCurrentPos(){
  if(currentPos >= seat.length - 1){
    currentPos = 0;
    totalIterations++;
  }else{
    currentPos++;
  }
}    

    
function shape(data) {
  for (var i = 0; i < data.n; i++) {
    var point = new Object;
    var angle = data.s + (i * (1 / data.n) * 2 * Math.PI);
    point.x = Math.round(data.x + (data.r * Math.cos(angle)));
    point.y = Math.round(data.y + (data.r * Math.sin(angle)));
    points.push(point);
    seat.push({angle: angle, live: true});
    var pointTxt = new Object;
    pointTxt.x = Math.round(data.x + ((data.r + 10) * Math.cos(angle)));
    pointTxt.y = Math.round(data.y + ((data.r + 10) * Math.sin(angle)));
    
    var t = paper.text(pointTxt.x, pointTxt.y, i + 1).attr({'text-anchor': 'middle'});  
    /*
    */
  }
  //console.log(points);
  
  var strp = "M" + points[0].x + " " + points[0].y;
  for (var i = 1; i < data.n; i++) {
    strp += "L" + points[i].x + " " + points[i].y;
  }
  strp += "L" + points[0].x + " " + points[0].y;
  var comb = paper.path(strp).attr({fill:"rgb(255,255,193)"});
  /*
  comb.mouseover(function(event){
    this.attr({fill:"rgb(255,128,64)"});
  });
  comb.mouseout(function(event){
    this.animate({fill:"rgb(255,255,193)"},500);
  });
  */
}

function drawCircle(nodes) {
  var newPath = []
  for (var i = 0; i <= nodes; i++) {
    var deg = (i*1.0 / nodes) * 360;
    var x = Math.cos(deg * Math.PI / 180) * radius
    var y = Math.sin(deg * Math.PI / 180) * radius
    if (newPath == 0) newPath.push("M " + x + " " + y)
    else newPath.push("A " + (radius) + "," + (radius) + ",0,0,1," + x + "," + y)
  }
  newPath.push("Z")
  console.log(newPath)
  paper.path(newPath).attr({
    "fill1": "#000"
  }).translate(300, 300)
}

//var paper = Raphael(10, 50, 320, 200);
    
  </script>
</head>

<body>
<div class="well">
<form role="form">
  <div class="form-group">
    <div class="pull-left">
      <div id='sliderN'></div>
      <span id='sliderMsg'>Simulate 3 to 16 seats</span>
    </div>
    <div class="pull-left">
      <div id='speed'></div>
      <span id='speedMsg'>Speed is 5000</span>
    </div>
    <button id="startBtn" type="button" class="btn btn-success">Start</button>
    <button id="stopBtn" type="button" class="btn btn-danger">Stop</button>
  </div>
</form>
  
</div>

<div id="canvas"></div>
<div id="logArea">
  <table id="resultTable" class="table table-bordered">
    <tr>
      <th>Total Seat</th>
      <th>Surviver</th>
    </tr>
  </table>
  <ul id="log"></ul>
</div>

</body>
</html>
