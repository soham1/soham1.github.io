<!DOCTYPE html>
<html lang="">
<head>
<meta charset="UTF-8">
<title></title>
<link rel="stylesheet" href="bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css">
<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
<style>
  
  .dead{
    background-color: #FF5C33;
  }
  
  .live{
    background-color: #99FF33;
  }
  
  .seatingBox tr td, .finalResults tr td{
    width: 20px;
    text-align: center;
    margin: 2px;
    border: thin dotted grey;
  }

  .seatingBox, .finalResults{
    margin: 20px;
  }
  
  .winnerSeat{
    font-weight: bolder;
    background-color: palegreen;
  }
  
  .highlight{
    background-color: yellow;
  }
  
  #theChart{
    margin-top: 20px;
  }
  
</style>

<script src="js/raphael-min.js"></script>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script src="bower_components/jquery-ui/jquery-ui.min.js"></script>
<script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="js/Chart.min.js"></script>

<script>

  $(function(){
    readParams();
    init();
  });
  
  var finalResults = [];
  var totalSeat = 1;
  var maxSeat = 32;
  var currentSeat = 1;
  var seats = [];
  var iteration = 0;
  var timerId;
  var speed = 5;
  var live = true;
  var powerOnly = false;
  
  function readParams(){
    var ms = getParameterByName('maxSeat');
    console.log(ms);
    if(ms != ''){
      maxSeat = Number(ms);
    }
    var po = getParameterByName('powerOnly');
    console.log(po);
    if(po == 'true'){
      powerOnly = true;
    }
    
    
  }
  
  function nextBatch(){
    var i = finalResults.length - 1;
    var highlightClass = "";
    if(isPowerOf2(totalSeat)){
      highlightClass = 'highlight';
    }
    $('.finalResults').append('<tr><td class="'+highlightClass+'">'+ finalResults[i].totalSeat +'</td><td>' + finalResults[i].winner + '</td></tr>');
    if(powerOnly){
      totalSeat *= 2;
    }else{
      totalSeat++;
    }
    if(totalSeat <= maxSeat){
      currentSeat = 1;
      seats = [];
      iteration = 0;
      live = true;
      $('tr[id], td[id]').each(function(){
        $(this).removeAttr('id');
      });
      init();
    }else{
      var labels = [];
      var dataset = [];
      for(var i = 0; i < finalResults.length; i++){
        labels.push(finalResults[i].totalSeat);
        dataset.push(finalResults[i].winner);
      }
      var ctx = document.getElementById("theChart").getContext("2d");
      var options = {bezierCurve : false};
      var myLineChart = new Chart(ctx).Line({labels: labels, datasets: [{data: dataset}] }, options);
    }
  }
  
  function isPowerOf2(num){
    var i = 0;
    while(true){
      var p = Math.pow(2, i++);
      if(p == num){
        return true;
      }else if(p > num){
        return false;
      }
    }
    return false;
  }
  
  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }
  
  function init(){
    //$('.seatingBox').empty();
    $('#allTables').prepend('<table class="seatingBox ts' + totalSeat + '"></table>');
    var newRow = $('.seatingBox.ts' + totalSeat).append('<tr id="iteration-' + iteration + '"></tr>');
    //console.log(newRow);
    var row = $('#iteration-' + iteration);
    for(var i = 1; i <= totalSeat; i++){
      var id = 'seat-' + i;
      row.append('<td id="' + id +'">' + i + '</td>');
      seats.push({live: true});
    }
    row.append('<td>#</td>');
    row.append('<td class="dead"></td>');
    row.append('<td class="live"></td>');
    //Just to make a new row
    currentSeat = totalSeat + 1;
    startIteration();
  }
  
  function colorSeat(){
    var seatEle = getSeatEle();
    if(seats[currentSeat - 1].live){
      seatEle.addClass('live');
    }else{
      seatEle.addClass('dead');
    }
  }
  
  function startIteration(){
    getNextSeat();
    seats[currentSeat - 1].live = live;
    updateDead();
    colorSeat();    
    live = !live;
    if(checkOneLeft()){
      clearTimeout(timerId);
      colorRemaining();
      var i = getLastLiveIndex();
      $('#seat-' + i).addClass('winnerSeat');
      finalResults.push({totalSeat: totalSeat, winner: i});
      //console.log(finalResults);
      nextBatch();
      return;
    }
    timerId = setTimeout(startIteration, speed);
  }
  
  function getSeatEle(){
    var id = '#seat-' + iteration + '-' + currentSeat;
    return $(id);
  }
  
  function updateDead(){
    var deadId = '#dead-' + iteration;
    var liveId = '#live-' + iteration;
    var id = '#dead-' + iteration;
    var deadCtr = 0;
    for(var i = 0; i < totalSeat; i++){
      if(!seats[i].live) deadCtr++;
    }
    $(deadId).text(deadCtr);
    $(liveId).text(totalSeat - deadCtr);
  }
  
  function getNextSeat(){
    currentSeat++;
    if(currentSeat > totalSeat){
      currentSeat = 1;
      iteration++;
      var newRow = $('.seatingBox').append('<tr id="iteration-' + iteration + '"></tr>');
      var row = $('#iteration-' + iteration);
      for(var i = 1; i <= totalSeat; i++){
        var id = 'seat-' + iteration + '-' + i;
        row.append('<td id="' + id +'">&nbsp;</td>');
      }
      id = 'itr-' + iteration;
      row.append('<td id="' + id +'">'+ iteration +'</td>');
      id = 'dead-' + iteration;
      row.append('<td id="' + id +'"></td>');
      id = 'live-' + iteration;
      row.append('<td id="' + id +'"></td>');
    }
    if(!seats[currentSeat - 1].live){
      //console.log('skip');
      colorSeat();    
      getNextSeat();
    }
  }
  
  function colorRemaining(){
    for(; currentSeat <= totalSeat; currentSeat++){
      colorSeat();    
    }
  }
  
  function getLastLiveIndex(){
    for(var i = 0; i < totalSeat; i++){
      if(seats[i].live) return i + 1;
    }
    return -1;
  }
  
  function checkOneLeft(){
    var liveCtr = 0;
    for(var i = 0; i < totalSeat; i++){
      if(seats[i].live) liveCtr++;
    }
    return liveCtr == 1;
  }
  
</script>  
  
  
</head>
<body>
  <table class="finalResults pull-left">
    <tr>
      <th>Seats</th>
      <th>Winner</th>
    </tr>
  </table>
  <canvas class="pull-left" id="theChart" width="900" height="600"></canvas>
  <div style="clear: both"></div>
  <div id="allTables"></div>

</body>
</html>
